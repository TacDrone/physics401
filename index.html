<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard นักเรียนฟิสิกส์ ม.4/1</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Kanit', sans-serif;
            background-color: #f8fafc; /* slate-50 */
            color: #1e293b; /* slate-800 */
            overflow-x: hidden;
        }
        #bg-canvas {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            opacity: 0.6;
        }
        .progress-bar-container {
            background-color: #e2e8f0; /* slate-200 */
            border-radius: 9999px;
            overflow: hidden;
            height: 1rem;
            width: 100%;
        }
        .progress-bar {
            background: linear-gradient(90deg, #38bdf8, #6366f1); /* sky-400 to indigo-500 */
            height: 100%;
            border-radius: 9999px;
            transition: width 1.5s ease-in-out;
        }
        .card {
            background-color: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(226, 232, 240, 0.5);
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            transform-style: preserve-3d;
            transition: transform 0.2s ease-out, box-shadow 0.2s ease-out;
        }
        .winner-card-highlight {
            animation: winner-card-glow 2s infinite alternate;
        }
        /* Button Animations */
        .btn-action {
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        .btn-action:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
        }
        .btn-action:active {
            transform: translateY(0px);
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
        }
        /* Modal styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            transition: opacity 0.3s ease;
        }
        .modal-content {
            background-color: #f1f5f9; /* slate-100 */
            padding: 2rem;
            border-radius: 0.75rem;
            text-align: center;
            border: 1px solid #cbd5e1; /* slate-300 */
            box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
            min-width: 320px;
            max-width: 90%;
        }
        .modal-overlay:not(.hidden) .modal-content {
            animation: bounceIn 0.5s ease-out forwards;
        }
        .modal-winner-name {
            font-size: 2.25rem; /* text-4xl */
            font-weight: 700;
            color: #4f46e5; /* indigo-600 */
            margin: 1.5rem 0;
            min-height: 100px;
            letter-spacing: 1px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
        }
        .winner-reveal {
            animation: winner-glow 1.5s ease-in-out;
        }
        .troll-text {
            font-size: 1.25rem;
            font-weight: 500;
            color: #ef4444; /* red-500 */
            margin-top: 0.5rem;
            animation: fadeIn 0.5s;
        }

        /* Keyframe Animations */
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        @keyframes slideUpFadeIn {
            from { opacity: 0; transform: translateY(30px); }
            to { opacity: 1; transform: translateY(0); }
        }
        @keyframes bounceIn {
            0% { transform: scale(0.5); opacity: 0; }
            60% { transform: scale(1.05); opacity: 1; }
            100% { transform: scale(1); }
        }
        @keyframes winner-glow {
            0%, 100% { transform: scale(1); text-shadow: 0 0 8px rgba(245, 158, 11, 0.5); }
            50% { transform: scale(1.1); text-shadow: 0 0 16px rgba(252, 211, 77, 0.8), 0 0 24px rgba(252, 211, 77, 0.5); }
        }
        @keyframes winner-card-glow {
            from { box-shadow: 0 0 5px #f59e0b, 0 0 10px #f59e0b, 0 0 15px #f59e0b; }
            to { box-shadow: 0 0 15px #fcd34d, 0 0 25px #fcd34d, 0 0 35px #fcd34d; }
        }
    </style>
</head>
<body class="antialiased">
    
    <canvas id="bg-canvas"></canvas>

    <div class="relative min-h-screen w-full flex flex-col items-center p-4 sm:p-6 lg:p-8 pb-20">
        <header class="text-center mb-6">
            <h1 class="text-3xl sm:text-4xl md:text-5xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-sky-500 to-indigo-600">
                นักเรียนฟิสิกส์ ม.4/1
            </h1>
            <p class="text-lg sm:text-xl text-slate-500 mt-2">โรงเรียนธัญรัตน์</p>
        </header>

        <!-- Action Buttons -->
        <div class="flex flex-wrap justify-center gap-4 mb-6">
            <button id="top-5-btn" class="btn-action bg-sky-500 hover:bg-sky-600 text-white font-bold py-2 px-4 rounded-lg shadow-md">ดู 5 อันดับแรก</button>
            <button id="show-all-btn" class="btn-action bg-indigo-500 hover:bg-indigo-600 text-white font-bold py-2 px-4 rounded-lg shadow-md">แสดงทั้งหมด</button>
            <button id="random-btn" class="btn-action bg-amber-500 hover:bg-amber-600 text-white font-bold py-2 px-4 rounded-lg shadow-md animate-pulse">สุ่มรางวัล!</button>
        </div>

        <main id="student-dashboard" class="w-full max-w-7xl grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            <!-- Student data will be injected here by JavaScript -->
        </main>
    </div>

    <!-- Random Winner Modal -->
    <div id="winner-modal" class="modal-overlay hidden opacity-0">
        <div class="modal-content">
            <h2 class="text-2xl font-bold text-slate-800">ผู้โชคดีคือ...</h2>
            <div id="winner-name" class="modal-winner-name">กำลังสุ่ม...</div>
            <button id="close-modal-btn" class="btn-action bg-slate-500 hover:bg-slate-600 text-white font-bold py-2 px-6 rounded-lg">ปิด</button>
        </div>
    </div>

    <!-- Applause Effect -->
    <div id="applause-effect" class="fixed inset-0 flex justify-center items-center z-[1002] pointer-events-none hidden">
        <img src="https://media.tenor.com/vj2L3r2t7wAAAAAC/clapping-hands.gif" alt="Applause" class="w-1/2 max-w-xs opacity-90" onerror="this.style.display='none'">
    </div>


    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.5.1/dist/confetti.browser.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>
    <script>
        // --- Student Data (Updated from Google Sheet) ---
        const studentData = [
            { name: "น.ส. ครองขวัญ ผลมะขาม", score: 32187 },
            { name: "น.ส. ธารข้าว อ่วมพันธ์เจริญ", score: 37989 },
            { name: "น.ส. นิษฐวรรณ์ หลีนวรัตน์", score: 12519 },
            { name: "น.ส. ปะภาวรินทร์ สวยสะอาด", score: 33947 },
            { name: "น.ส. พลอยยวีณ์ ประกอบบุญกุล", score: 35014 },
            { name: "น.ส. เพชรปวีณ์ ประกอบบุญกุล", score: 29822 },
            { name: "น.ส. รัตนาภา ชูกลิ่น", score: 25997 },
            { name: "นาย คุณานนท์ เทียงโงก", score: 35579 },
            { name: "นาย ใจเพชร ยอดขันธ์", score: 0 },
            { name: "นาย ชนกันต์ บุตตะนันท์", score: 47705 },
            { name: "นาย ชินกฤต แก้วกระจ่าง", score: 13464 },
            { name: "นาย ฐาปกรณ์ ติงสง่า", score: 25674 },
            { name: "นาย ณัฐสิริ สารโกศล เกษกำธร", score: 36742 },
            { name: "นาย ทักษ์ดนัย คงอยู่", score: 12634 },
            { name: "นาย ปวรปรัชญ์ ประดิษฐ", score: 38613 },
            { name: "นาย พชรวศิน ไทยกลาง", score: 39422 },
            { name: "นาย วรรณกฤตย์ ใจกล้า", score: 11219 },
            { name: "นาย ศิริบุตร เชิดโคกสูง", score: 14762 },
            { name: "นาย สิรภพ อักษรพาลี", score: 27125 },
            { name: "นาย อัครพล เกตุเอี่ยม", score: 46 },
            { name: "น.ส. จิรชยา ทรงภักดีกุล", score: 32395 },
            { name: "น.ส. ธนาวรรณ จันทร์อ้น", score: 25656 },
            { name: "น.ส. ธนิศรา แซ่แต้", score: 30487 },
            { name: "น.ส. วณิชยา ทาหาร", score: 69 },
            { name: "นาย นวพรรษ ศรีทอง", score: 19984 },
            { name: "นาย ภูมิพัฒน์ แก้ววงษา", score: 30704 },
            { name: "นาย วีระพงษ์ แหวนเพชร", score: 11219 },
            { name: "นาย ปุญญพัตน์ เสาร์ศิริ", score: 25337 },
            { name: "น.ส. กมลวรรณ แก้วสุกใส", score: 41165 },
            { name: "น.ส. พัทธนันท์ จิรายุวัฒน์", score: 35650 },
            { name: "น.ส. ภิญญาพัชร์ จักษุนิมิตมงคล", score: 12634 },
            { name: "นาย กฤตเมธ ใจกล้า", score: 38 },
            { name: "นาย พงศทร อาภาผล", score: 10349 },
            { name: "นาย ศรัณยู อ่ำทิม", score: 16992}
        ];

        const dashboard = document.getElementById('student-dashboard');
        let maxScore = 1;
        let indexedStudentData = [];
        let rafflePool = [];
        let appState = {
            currentView: 'all' // 'all' or 'top-5'
        };

        // --- Sound System ---
        const shuffleSynth = new Tone.FMSynth({ harmonicity: 2, modulationIndex: 10, oscillator: { type: "sine" }, envelope: { attack: 0.01, decay: 0.1, sustain: 0.1, release: 0.1 } }).toDestination();
        const winnerFanfare = new Tone.Sequence((time, note) => { const synth = new Tone.PolySynth(Tone.Synth, { oscillator: { type: "fatsawtooth" }, envelope: { attack: 0.01, decay: 0.4, sustain: 0.2, release: 0.4 } }).toDestination(); synth.triggerAttackRelease(note, "8n", time); }, [["C4", "E4", "G4"], "A4", ["C5", "E5"] , "G5"], "8n");
        const slideWhistle = new Tone.Synth({ oscillator: { type: 'sine' }, envelope: { attack: 0.01, decay: 0.5, sustain: 0.1, release: 0.1 } }).toDestination();
        const sadTrombone = new Tone.Sequence((time, note) => { const synth = new Tone.Synth({ oscillator: { type: 'sawtooth' }, envelope: { attack: 0.01, decay: 0.2, sustain: 0.3, release: 0.2 } }).toDestination(); synth.triggerAttackRelease(note, '8n', time); }, ['D4', 'C#4', 'C4', 'B3'], '8n');
        const almostSound = new Tone.Sequence((time, note) => { const synth = new Tone.Synth({oscillator: {type: 'triangle8'}}).toDestination(); synth.triggerAttackRelease(note, '16n', time); }, ['C5', 'E5', 'G5'], '16n');
        Tone.Transport.start();

        // --- UI Rendering ---
        const renderStudentList = (data) => {
            dashboard.innerHTML = '';
            data.forEach((student, index) => {
                const scorePercentage = (student.score / maxScore) * 100;
                const studentCard = document.createElement('div');
                studentCard.className = 'card rounded-lg p-4 flex flex-col gap-2';
                studentCard.style.cssText = `animation: slideUpFadeIn 0.6s ease-out forwards; opacity: 0; animation-delay: ${index * 30}ms;`;
                studentCard.dataset.studentId = student.originalIndex;

                studentCard.innerHTML = `
                    <div class="flex items-center gap-4 w-full">
                        <span class="font-bold text-lg text-sky-600 w-8 text-center">${student.rank ? student.rank : student.originalIndex + 1}</span>
                        <div class="flex-1 w-full">
                            <div class="flex justify-between items-baseline mb-1">
                                <span class="font-semibold text-slate-700 text-sm sm:text-base">${student.name}</span>
                                <span class="text-xs sm:text-sm font-medium text-indigo-600">${student.score.toLocaleString()}</span>
                            </div>
                            <div class="progress-bar-container">
                                <div class="progress-bar" style="width: 0%;" data-width="${scorePercentage.toFixed(2)}%"></div>
                            </div>
                        </div>
                    </div>
                    <div class="mt-1 px-1">
                        <input type="number" class="score-input w-full p-1 rounded-md border border-slate-300 text-sm focus:ring-2 focus:ring-sky-500 focus:border-sky-500 outline-none" placeholder="เพิ่มคะแนนแล้ว Enter...">
                    </div>
                `;
                dashboard.appendChild(studentCard);
                
                // Add score input event listener
                studentCard.querySelector('.score-input').addEventListener('keydown', (e) => {
                    if (e.key === 'Enter') {
                        const valueToAdd = parseInt(e.target.value, 10);
                        if (!isNaN(valueToAdd) && e.target.value.trim() !== '') {
                            const studentToUpdate = indexedStudentData.find(s => s.originalIndex === student.originalIndex);
                            if (studentToUpdate) {
                                studentToUpdate.score += valueToAdd;
                            }
                            updateDashboard();
                        }
                        e.target.value = ''; // Clear input
                    }
                });

                // 3D Hover Effect
                studentCard.addEventListener('mousemove', (e) => {
                    const rect = studentCard.getBoundingClientRect();
                    const x = e.clientX - rect.left - rect.width / 2;
                    const y = e.clientY - rect.top - rect.height / 2;
                    const rotateY = (x / rect.width) * 15;
                    const rotateX = -(y / rect.height) * 15;
                    studentCard.style.transform = `perspective(1000px) rotateX(${rotateX}deg) rotateY(${rotateY}deg) scale3d(1.05, 1.05, 1.05)`;
                });
                studentCard.addEventListener('mouseleave', () => {
                    studentCard.style.transform = 'perspective(1000px) rotateX(0) rotateY(0) scale3d(1, 1, 1)';
                });
            });

            setTimeout(() => {
                document.querySelectorAll('.progress-bar').forEach(bar => {
                    bar.style.width = bar.dataset.width;
                });
            }, 100);
        };
        
        const updateDashboard = () => {
            removeWinnerHighlight();
            maxScore = Math.max(...indexedStudentData.map(s => s.score), 1);
            let dataToRender;
            if (appState.currentView === 'top-5') {
                const sortedData = [...indexedStudentData].sort((a, b) => b.score - a.score);
                dataToRender = sortedData.slice(0, 5).map((s, i) => ({ ...s, rank: i + 1 }));
            } else {
                dataToRender = indexedStudentData.map(s => ({...s, rank: null}));
            }
            renderStudentList(dataToRender);
        };

        const removeWinnerHighlight = () => {
            const highlighted = document.querySelector('.winner-card-highlight');
            if (highlighted) {
                highlighted.classList.remove('winner-card-highlight');
            }
        };

        const resetRafflePool = () => {
            rafflePool = [...indexedStudentData];
            console.log(`Raffle pool reset with ${rafflePool.length} students.`);
        };
        
        // --- Event Listeners and Main Logic ---
        document.addEventListener('DOMContentLoaded', () => {
            indexedStudentData = studentData.map((s, i) => ({...s, originalIndex: i}));
            resetRafflePool();
            updateDashboard();

            document.getElementById('top-5-btn').addEventListener('click', () => {
                appState.currentView = 'top-5';
                updateDashboard();
            });

            document.getElementById('show-all-btn').addEventListener('click', () => {
                appState.currentView = 'all';
                updateDashboard();
            });

            const modal = document.getElementById('winner-modal');
            const winnerNameEl = document.getElementById('winner-name');
            const applauseEl = document.getElementById('applause-effect');
            let isShuffling = false;

            document.getElementById('random-btn').addEventListener('click', async () => {
                if (isShuffling) return;
                isShuffling = true;
                removeWinnerHighlight();
                await Tone.start();
                
                winnerNameEl.className = 'modal-winner-name';
                modal.classList.remove('hidden', 'opacity-0');
                
                if (rafflePool.length === 0) {
                    winnerNameEl.innerHTML = '<span>กำลังเริ่มรอบใหม่...</span>';
                    await new Promise(resolve => setTimeout(resolve, 1500));
                    resetRafflePool();
                    winnerNameEl.innerHTML = `<span>ทุกคนมีสิทธิ์ลุ้นอีกครั้ง! (${rafflePool.length} คน)</span>`;
                    await new Promise(resolve => setTimeout(resolve, 2000));
                }
                
                winnerNameEl.innerHTML = '<span>...</span>';

                // --- NEW RAFFLE LOGIC ---
                const winnerPoolIndex = Math.floor(Math.random() * rafflePool.length);
                const actualWinner = rafflePool.splice(winnerPoolIndex, 1)[0]; // Pick and remove winner
                
                // Select trolls from the REMAINING pool
                const remainingStudents = [...rafflePool];
                let trollWinner1 = actualWinner, trollWinner2 = actualWinner;
                if (remainingStudents.length > 0) {
                   trollWinner1 = remainingStudents.splice(Math.floor(Math.random() * remainingStudents.length), 1)[0];
                }
                if (remainingStudents.length > 0) {
                   trollWinner2 = remainingStudents.splice(Math.floor(Math.random() * remainingStudents.length), 1)[0];
                }

                const teasingMessages = ["กำลังคำนวณความน่าจะเป็น...", "ตรวจสอบกับดวงดาว...", "ใครกันนะ...", "คนนี้รึเปล่า?", "ถามอาจารย์อังคณาก่อน..."];
                const notes = ["C4", "D4", "E4", "F4", "G4", "A4", "B4"];
                let shuffleCount = 0;
                const shuffleInterval = 100;
                const totalDuration = 7000;
                const trollRevealTime = 4000;
                let intervalId;

                const shuffleNames = () => {
                    const randomStudent = indexedStudentData[Math.floor(Math.random() * indexedStudentData.length)];
                    winnerNameEl.innerHTML = `<span>${randomStudent.name}</span>`;
                    shuffleSynth.detune.value = (Math.random() - 0.5) * 50;
                    shuffleSynth.triggerAttackRelease(notes[shuffleCount % notes.length], "16n");
                    shuffleCount++;
                };

                intervalId = setInterval(shuffleNames, shuffleInterval);

                // Main troll moment
                setTimeout(() => {
                    clearInterval(intervalId);
                    winnerNameEl.innerHTML = `<span>${trollWinner1.name}</span><span class="troll-text">หรือว่าจะเป็นคนนี้...</span>`;
                    almostSound.start();
                }, trollRevealTime - 1500);

                setTimeout(() => {
                    winnerNameEl.innerHTML = `<span>${trollWinner1.name}</span><span class="troll-text" style="color: #dc2626;">...ยังไม่ใช่จ้าาา!</span>`;
                    slideWhistle.frequency.setValueAtTime("C6", Tone.now());
                    slideWhistle.frequency.linearRampToValueAtTime("C4", Tone.now() + 0.5);
                    slideWhistle.triggerAttackRelease("0.5s", Tone.now());
                    setTimeout(() => sadTrombone.start(), 500);
                }, trollRevealTime);

                // Final Reveal
                setTimeout(() => {
                    winnerNameEl.innerHTML = `<span>${actualWinner.name}</span>`;
                    winnerNameEl.classList.add('winner-reveal');
                    
                    document.querySelector(`[data-student-id='${actualWinner.originalIndex}']`)?.classList.add('winner-card-highlight');
                    
                    winnerFanfare.start();
                    confetti({ particleCount: 250, spread: 120, origin: { y: 0.6 }, zIndex: 1001 });
                    
                    applauseEl.classList.remove('hidden');
                    setTimeout(() => { applauseEl.classList.add('hidden'); }, 3000);

                    isShuffling = false;
                }, totalDuration);
            });

            document.getElementById('close-modal-btn').addEventListener('click', () => {
                modal.classList.add('opacity-0');
                setTimeout(() => modal.classList.add('hidden'), 300);
                
                if(winnerFanfare.state === 'started') winnerFanfare.stop();
                if(sadTrombone.state === 'started') sadTrombone.stop();
                if(almostSound.state === 'started') almostSound.stop();
                Tone.Transport.cancel();
            });
        });

        // --- Three.js Background Animation ---
        let scene, camera, renderer, stars;
        let mouseX = 0, mouseY = 0;
        function initThreeJS() {
            scene = new THREE.Scene();
            camera = new THREE.PerspectiveCamera(60, window.innerWidth / window.innerHeight, 1, 1000);
            camera.position.z = 5;

            const canvas = document.getElementById('bg-canvas');
            renderer = new THREE.WebGLRenderer({ canvas: canvas, antialias: true, alpha: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setClearColor(0x000000, 0);

            const starGeometry = new THREE.BufferGeometry();
            const starCount = 5000;
            const positions = new Float32Array(starCount * 3);
            for (let i = 0; i < starCount * 3; i++) {
                positions[i] = (Math.random() - 0.5) * 600;
            }
            starGeometry.setAttribute('position', new THREE.BufferAttribute(positions, 3));
            
            const starMaterial = new THREE.PointsMaterial({ color: 0x475569, size: 0.7, transparent: true, blending: THREE.AdditiveBlending, depthWrite: false });
            stars = new THREE.Points(starGeometry, starMaterial);
            scene.add(stars);
            animateThreeJS();
        }

        function animateThreeJS() {
            stars.rotation.y += mouseX * 0.0001;
            stars.rotation.x += mouseY * 0.0001;
            renderer.render(scene, camera);
            requestAnimationFrame(animateThreeJS);
        }

        function onWindowResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        }
        
        function onMouseMove(event) {
            mouseX = event.clientX - (window.innerWidth / 2);
            mouseY = event.clientY - (window.innerHeight / 2);
        }

        window.addEventListener('resize', onWindowResize, false);
        document.addEventListener('mousemove', onMouseMove, false);
        initThreeJS();
    </script>
</body>
</html>
